---
title: "Peak Bloom Prediction Demo"
author: "Ken Koon Wong, Chao-ping Wu, Anirban Bhatthacharrya"
date: "01/01/2022"
output:
  html_document:
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = FALSE, 
                      message = FALSE,
                      fig.align = 'center',
                      out.width = '80%')
```


# library
```{r}
library(tidyverse)
library(lubridate)
library(tidyverse)
# library(emayili)
library(jsonlite)
library(httr)
library(lubridate)
library(curl)
```


## Loading the data

The data for each of the three main sites is provided as simple text file in CSV format.
Each file contains the dates of the peak bloom of the cherry trees at the respective site, alongside the geographical location of the site.

The six columns in each data file are

* _location_ a human-readable location identifier (`string`).
* _lat_ (approximate) latitude of the cherry trees (`double`).
* _long_ (approximate) longitude of the cherry trees (`double`).
* _alt_ (approximate) altitude of the cherry trees (`double`).
* _year_ year of the observation (`integer`).
* *bloom_date* date of peak bloom of the cherry trees (ISO 8601 date `string`). The "peak bloom date" may be defined differently for different sites
* *bloom_doy* days since January 1st of the year until peak bloom (`integer`). January 1st corresponds to `1`.

In R, the data files can be read with `read.csv()` and concatenated with the `bind_rows()` function:

```{r}
cherry <- read.csv("data/washingtondc.csv") %>% 
  bind_rows(read.csv("data/liestal.csv")) %>% 
  bind_rows(read.csv("data/kyoto.csv")) %>%
  mutate(bloom_date = ymd(bloom_date))
  
```


# exploring variable on cherry
```{r}
cherry %>% summary()
# we have Location, lat, long, alt, year, bloom_date and bloom day

# this (bloom_day) will be out response/outcome variable, let's see if bloom_day is normally distributed
shapiro.test(cherry$bloom_doy) #W = 0.9873, p-value = 5.751e-08, not normal
# let's visualize this 
hist(cherry$bloom_doy) # left skewed
hist(log(cherry$bloom_doy)) # tried logging but still not normal, 

#?any difference in site, let's visualize
cherry %>%
  ggplot(.,aes(x=bloom_doy,fill=location)) +
  geom_histogram(alpha = 0.5) # interesting, looks like it might be site related

# let's test shapiro normality w each site
map(.x=cherry$location %>% unique(),.f=~cherry %>% filter(location == !!.x) %>% pull(bloom_doy) %>% shapiro.test()) # much better !!! all 3 sites p >0.05, no need special transition to predict

```



## Visualizing the time series
```{r}
cherry %>%
  ggplot(.,aes(x=bloom_date,y=bloom_doy,color=location)) +
  geom_point() +
  geom_line() +
  scale_x_date(date_labels = "%b %Y") # wow, kyoto data goes back to the year 812 and up... let's filter to a lil bit more recent like 1950

cherry %>%
  filter(bloom_date >= mdy("1-1-1950")) %>%
  ggplot(.,aes(x=bloom_date,y=bloom_doy,color=location)) +
  geom_point() +
  geom_line(alpha=0.5) +
  geom_smooth() +
  scale_x_date(date_labels = "%b %Y") # very interesting, they all seem to follow a cyclical trend

```

#Cherry trees need a full month of chilly weather below 41 degrees to properly blossom when it gets warmer, according to Naoko Abe, author of The Sakura Obsession. If they don't get that chilly weather, they blossom later because "they can't wake up properly," Abe says. https://www.npr.org/2021/04/05/984470981/what-the-cherry-blossom-bloom-can-tell-us-about-climate-change

# let's do a simple causal diagram and see if we can find other data to generate a prediction model
```{r}
library(dagitty)
library(ggdag)

dag <- dagify(
  bloom_doy ~ cherry_type + cold_more_than_30d + location + altitude,
  cold_more_than_30d ~ location + altitude,
  cherry_type ~ location + altitude,
  exposure = "cold_more_than_30d",
  outcome = "bloom_doy"
  
)


set.seed(11)
ggdag_status(dag, text_col = "black") +
  theme_dag()

paths(dag)
ggdag_dseparated(dag, controlling_for = c("location","altitude","cherry_type","cold_more_than_30d"))
# looks like have to control for all of the above to d-separate

```


# let's see if we can find above data from available dataset provided
```{r}
read_csv("data/meteoswiss.csv") %>% view() #has other location in switzerland's bloom doy
read_csv("data/USA-NPN_individual_phenometrics_data.csv") %>% view() # interestingly US data has different species of cherry blossom and different state too with tmax of each season and percipitation etc, but no info on our variables in causal diagram (30d cold)
# let's do EDA on the above US data
df <- read_csv("data/USA-NPN_individual_phenometrics_data.csv") 

library(geofacet)
df %>%
  ggplot(.,aes(x=First_Yes_Year,y=First_Yes_DOY,color=Species)) +
  geom_point() +
  geom_line() +
  facet_geo(~State) # hmmm... looks like species and state may be factor to bloom_doy, difficult to say with limited data, but from sparse data, species does play a role


```



# can we get weather data?
```{r}
library(tidyverse)
# library(emayili)
library(jsonlite)
library(httr)
library(lubridate)
library(curl)

base <- "https://api.openweathermap.org/data/2.5/onecall?lat=41.0989&lon=-81.6446&exclude=minutely,daily&appid=642ce95cc88ae923ab2cbe05ca8f73c1&units=imperial"
```


## Predicting the peak bloom

A very simple method to predict peak bloom date in the future is to fit a least-squares line through the observed dates and extrapolate the regression function.
We want to have a separate line for each location, hence we tell R to estimate _interaction_ effects.
We only use data from 1880 to fit the trends, as prior data may not be as reliable/relevant.

```{r}
# Fit simple least-squares lines for all sites.
ls_fit <- lm(bloom_doy ~ location * year, data = cherry, subset = year >= 1880)

summary(ls_fit)
```

This simple linear regression functions suggest a trend toward earlier peak bloom at all 3 sites.
We can compute the actual predictions using the `predict()` function and 

```{r}
# Compute the predictions for all 3 sites
predictions <- expand_grid(location = unique(cherry$location),
                           year = 1880:2031) %>% 
  bind_cols(predicted_doy = predict(ls_fit, newdata = .))

# Plot the predictions alongside the actual observations for 1990 up to 2032.
cherry %>% 
  right_join(predictions, by = c('year', 'location')) %>%
  filter(year >= 1880) %>% 
  ggplot(aes(x = year, y = predicted_doy)) +
  geom_line(aes(color = year > 2021), size = 1) +
  geom_point(aes(y = bloom_doy)) +
  scale_color_manual(values = c('FALSE' = 'gray50', 'TRUE' = 'blue'),
                     guide = 'none') +
  facet_grid(cols = vars(str_to_title(location))) +
  labs(x = "Year", y = "Peak bloom (days since Jan 1st)")
```

Based on this very simple model, the peak bloom dates at the three sites are very similar across the 10 years:

```{r}
#' Small helper function to convert the day of year to
#' the actual date.
#' 
#' @param year year as an integer
#' @param doy day of the year as integer (1 means January 1st)
#' @return date string
doy_to_date <- function (year, doy) {
  strptime(paste(year, doy, sep = '-'), '%Y-%j') %>% # create date object
    strftime('%Y-%m-%d') # translate back to date string in ISO 8601 format
}

predictions %>% 
  filter(year > 2021) %>% 
  mutate(predicted_doy = round(predicted_doy),
         predicted_date = doy_to_date(year, predicted_doy))
```

## Extrapolating to Vancouver, BC

For the cherry trees in Vancouver, BC, no historical data is available.
The trees are located approximately at 49.2236916°N (latitude), -123.1636251°E (longitude), 24 meters above sea levels (altitude).
Casual observations have been recorded in the way of photos posted to the [VCBF Neighbourhood Blog for Kerrisdale](https://forums.botanicalgarden.ubc.ca/threads/kerrisdale.36008/).
You can search the forum for the keywords "Akebono" (i.e., the name of the cultivar) and "Maple Grove Park" (i.e., the location of the trees).

We need to *extrapolate* from what we have learned about the peak bloom dates in the other locations to Vancouver.
The simple model we have fitted above, however, does not allow us to transfer any knowledge from the other sites to Vancouver -- we have only used the history trend at the respective sites.

Although the climate in Vancouver is different from the other locations, the simplest way to borrow information from the other locations is to average across these three sites.
Hence, we want to fit a straight line through the peak bloom dates, ignoring the actual site:

```{r}
# Fit simple least-squares lines for all sites.
ls_fit_for_van <- lm(bloom_doy ~ year, data = cherry, subset = year >= 1880)

predictions_vancouver <- tibble(location = 'vancouver',
       year = 2022:2031) %>% 
  bind_cols(predicted_doy = round(predict(ls_fit_for_van, newdata = .)))
```

Not surprisingly, the predicted peak bloom dates for Vancouver are thus very similar to the other 3 sites:
```{r}
predictions_vancouver
```

We can now append these predictions to the predictions for the other sites:

```{r}
predictions <- bind_rows(predictions, predictions_vancouver)
```

## Preparing the submission file

Once we have the predictions for all four sites, we have to save them in the correct format for the competition.

```{r}
submission_predictions <- predictions %>% 
  filter(year > 2021) %>% 
  mutate(predicted_doy = round(predicted_doy)) %>% 
  pivot_wider(names_from = 'location', values_from = 'predicted_doy') %>% 
  select(year, kyoto, liestal, washingtondc, vancouver)

submission_predictions
```

For submission, these predictions must be saved as a CSV file.
**Important:** the CSV file must not have row names, which R adds by default. Specify `row.names=FALSE` to suppress them:

```{r, eval=FALSE}
write.csv(submission_predictions, file = "cherry-predictions.csv",
          row.names = FALSE)
```

## Appendix: Adding Covariates {#appendix-rnoaa}

We encourage you to find additional publicly-available data that will improve your predictions. For example, one source of global meteorological data comes from the Global Historical Climatology Network (GHCN), available in the `rnoaa` package. The package can also be installed via 

```{r, eval = FALSE}
install.packages("rnoaa")
```

and the loaded via

```{r}
library(rnoaa)
```

The list of stations can be retrieved using the `ghcnd_stations()` function. Note that the closest weather station to each city with continuously collected maximum temperatures are USC00186350 (Washington D.C.), GME00127786 (Liestal), JA000047759 (Kyoto), and CA001108395 (Vancouver).

```{r, eval = FALSE}
stations <- ghcnd_stations()
```

As a simple demonstration, we retrieve the average seasonal maximum daily temperature (in 1/10 °C) from these stations using our own `get_temperature()` function, which wraps the `ghcnd_search()` function in the `rnoaa` package. (N.b. `ghcnd_search()` returns a list. Each element of the list corresponds to an element of the `var` argument.)

```{r}
#' Get the annual average maximum temperature at the given station,
#' separated into the 4 meteorological seasons (Winter, Spring, Summer, Fall).
#' 
#' The seasons are span 3 months each.
#' Winter is from December to February, Spring from March to May,
#' Summer from June to August, and Fall from September to November.
#' Note that December is counted towards the Winter of the next year, i.e.,
#' temperatures in December 2020 are accounted for in Winter 2021.
#' 
#' @param stationid the `rnoaa` station id (see [ghcnd_stations()])
#' @return a data frame with columns
#'   - `year` ... the year of the observations
#'   - `season` ... the season (Winter, Spring, Summer, Fall)
#'   - `tmax_avg` ... average maximum temperate in tenth degree Celsius
get_temperature <- function (stationid) {
  ghcnd_search(stationid = stationid, var = c("tmax"), 
               date_min = "1950-01-01", date_max = "2022-01-31")[[1]] %>%
  mutate(year = as.integer(format(date, "%Y")),
         month = as.integer(strftime(date, '%m')) %% 12, # make December "0"
         season = cut(month, breaks = c(0, 2, 5, 8, 11),
                      include.lowest = TRUE,
                      labels = c("Winter", "Spring", "Summer", "Fall")),
         year = if_else(month == 0, year + 1L, year)) %>%
  group_by(year, season) %>%
  summarize(tmax_avg = mean(tmax, na.rm = TRUE))
}

historic_temperatures <-
  tibble(location = "washingtondc", get_temperature("USC00186350")) %>%
  bind_rows(tibble(location = "liestal", get_temperature("GME00127786"))) %>%
  bind_rows(tibble(location = "kyoto", get_temperature("JA000047759"))) %>%
  bind_rows(tibble(location = "vancouver", get_temperature("CA001108395")))

historic_temperatures %>%
  ggplot() + 
  aes(year, tmax_avg) + 
  geom_line() +
  xlim(1950, 2031) +
  labs(x = "Year", y = "Average maximum temperature (1/10 °C)") +
  facet_grid(factor(season) ~ str_to_title(location))
```

We then predict the peak bloom date in two steps. Step 1 extrapolates average winter and spring temperature until 2031 using simple linear regression. Step 2 predicts the peak bloom date given the extrapolated temperatures, again using simple linear regression. 

```{r}
# Step 1. extrapolate average seasonal maximum temperature
ls_fit_temperature <- lm(tmax_avg ~ year * season + location, 
                         data = historic_temperatures)

temperature_predictions <-
  expand_grid(location = c("washingtondc", "liestal", "kyoto", "vancouver" ),
              season = c("Winter", "Spring", "Summer", "Fall"),
              year = 1950:2032) %>%
  bind_cols(predicted_temperature = 
              predict(ls_fit_temperature, newdata = .)) %>%
  filter(season %in% c("Winter", "Spring")) %>%
  pivot_wider(names_from = season, values_from = predicted_temperature)

# Step 2. predict bloom day from extrapolated temperatures
predictions_temperature <-
  temperature_predictions %>%
  left_join(cherry,
            by = c("location", "year")) %>%
  lm(bloom_doy ~ Spring * Winter, data = .) %>%
  predict(newdata = temperature_predictions) %>%
  round() %>%
  bind_cols(predicted_doy_temperature = ., temperature_predictions)
```

The following plot shows a comparison of predictions for Vancouver using the two methods described in this demo.

```{r}
predictions_vancouver %>%
  left_join(predictions_temperature,
            by = c("location", "year")) %>%
  pivot_longer(cols = c("predicted_doy", "predicted_doy_temperature")) %>%
  mutate(name = ifelse(name == "predicted_doy", 
                       "Method 1: location-based model", 
                       "Method 2: temperature-based model")) %>%
  ggplot() +
  aes(x = year, y = value, linetype = name) +
  geom_line() +
  labs(x = "Year", linetype = "",
       y = "Predicted peak bloom (days since Jan 1st) for Vancouver") +
  theme(legend.position = "bottom")
```


